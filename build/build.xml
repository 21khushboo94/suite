<?xml version="1.0" encoding="UTF-8"?>
<project name="GeoExplorer" default="dist" basedir=".">

    <description>
        GeoExplorer Build File
    </description>

    <property file="build.properties"/>

    <property name="javasrc" location="../java/src"/>
    <property name="war" location="../java/war"/>
    <property name="build" location="geoexplorer"/>
    <property name="port" value="8080"/>
    <condition property="narwhal.exe" value="narwhal.cmd" else="narwhal">
        <os family="windows"/>
    </condition>

    <path id="project.classpath">
        <pathelement location="../externals/narwhal/engines/rhino/jars/js.jar"/>
        <pathelement path="${javax.servlet.jar}/" />
    </path>

    <target name="init">
        <tstamp/>
        <mkdir dir="${build}"/>

        <echo message="pulling in buildkit (ignore fatal warning)"/>
        <mkdir dir="../externals/buildkit"/>
        <exec executable="git" dir="../externals/buildkit" failonerror="false">
            <arg line="clone -n git://github.com/tschaub/buildkit.git ."/>
        </exec>
        <exec executable="git" dir="../externals/buildkit" failonerror="true">
            <arg line="checkout 1d11f58b2d79cc042460d4ab0f411effcbfd7896"/>
        </exec>

        <echo message="pulling in narwhal (ignore fatal warning)"/>
        <mkdir dir="../externals/narwhal"/>
        <exec executable="git" dir="../externals/narwhal" failonerror="false">
            <arg line="clone -n git://github.com/tschaub/narwhal.git ."/>
        </exec>
        <exec executable="git" dir="../externals/narwhal" failonerror="true">
            <arg line="checkout 100c0ff2da88e55ed8c0f469d49e0f0a8eb19da5"/>
        </exec>

        <echo message="pulling in jack (ignore fatal warning)"/>
        <mkdir dir="../externals/jack"/>
        <exec executable="git" dir="../externals/jack" failonerror="false">
            <arg line="clone -n git://github.com/tlrobinson/jack.git ."/>
        </exec>
        <exec executable="git" dir="../externals/jack" failonerror="true">
            <arg line="checkout edabfc02070d1fd97ff71bc23dfa1a548bd45d56"/>
        </exec>

    </target>
    
    <target name="compile">
        <mkdir dir="classes"/>
        <javac srcdir="${javasrc}" destdir="classes" classpathref="project.classpath" debug="on" />
    </target>
    
    <target name="jar" depends="compile">
        <mkdir dir="jars"/>
        <jar destfile="jars/jack.jar" basedir="classes"/>
    </target>
    
    <target name="buildjs" depends="narwhal">
        <mkdir dir="script"/>
        <exec executable="${basedir}/narwhal/bin/${narwhal.exe}" dir="${basedir}" failonerror="true">
            <arg path="narwhal/packages/buildkit/lib/buildkit/build.js"/>
            <arg line="-o script jsbuild.cfg"/>
        </exec>
    </target>
    
    <target name="narwhal">

        <copy todir="narwhal">
            <fileset dir="../externals/narwhal"/>
        </copy>
        <copy todir="narwhal/packages/buildkit">
            <fileset dir="../externals/buildkit"/>
        </copy>
        <copy todir="narwhal/packages/jack">
            <fileset dir="../externals/jack"/>
        </copy>
        <copy todir="narwhal/packages/geoexplorer">
            <fileset dir="../package"/>
        </copy>
        <copy todir="narwhal" file="jackconfig.js"/>

        <chmod perm="a+x">
            <fileset dir="narwhal">
                <include name="**/bin/"/>
                <exclude name="**/.*"/>
            </fileset>
        </chmod>

    </target>
    
    <target name="debug" depends="narwhal">
        <exec executable="${basedir}/narwhal/bin/${narwhal.exe}" dir="${basedir}/narwhal" failonerror="true">
            <arg path="${basedir}/narwhal/packages/jack/lib/jackup.js"/>
            <arg value="-p ${port}"/>
        </exec>
    </target>
    
    <target name="dist" depends="clean, init, narwhal, buildjs, redist"/>
    
    <target name="redist">

        <copy todir="${build}">
            <fileset dir="${war}"/>
        </copy>

        <mkdir dir="${build}/WEB-INF/lib"/>
        <copy file="narwhal/engines/rhino/jars/js.jar" todir="${build}/WEB-INF/lib"/>
        <copy file="narwhal/packages/geoexplorer/jars/sqlitejdbc-v056.jar" todir="${build}/WEB-INF/lib"/>
        <copy file="jars/jack.jar" todir="${build}/WEB-INF/lib"/>
        
        <copy todir="${build}/WEB-INF/narwhal">
            <fileset dir="narwhal">
                <exclude name="**/.svn/"/>
                <exclude name="**/.svn*"/>
                <exclude name="**/examples/"/>
                <exclude name="**/tests/"/>
                <exclude name="**/docs/"/>
                <exclude name="**/zips/"/>
                <exclude name="**/.tusk/"/>
                <exclude name="**/*.md"/>
                <exclude name="**/*.db"/>
            </fileset>
        </copy>
        
        <delete dir="${build}/WEB-INF/narwhal/packages/geoexplorer/client/script"/>
        <copy todir="${build}/WEB-INF/narwhal/packages/geoexplorer/client/script">
            <fileset dir="script"/>
        </copy>
        
    </target>
    
    <target name="clean" description="remove previous build">
        <delete dir="${build}"/>
        <delete file="geoexplorer.war"/>
        <delete dir="narwhal"/>
        <delete dir="script"/>
    </target>
    
    <target name="war" depends="dist" description="create archive for servlet container">
        <war destfile="geoexplorer.war" webxml="${war}/WEB-INF/web.xml">
            <fileset dir="${build}"/>
        </war>
    </target>

</project>
