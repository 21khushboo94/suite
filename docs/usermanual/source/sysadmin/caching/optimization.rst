.. _sysadmin.caching.optimization:

Optimizing tile caches
======================

.. warning:: Document status: **Draft**

.. todo:: Are there other optimizations to add? Split these into individual sections?

While a tile cache for a layer automatically brings many improvements in performance—less time generating images, less redundancy—there are ways to optimize the cache so as to adjust it for your needs and improve performance even more.

Use 8-bit images
----------------

PNG (Portable Network Graphics) is a popular file format for bitmap images. PNG is used in most cases except where a lossy compression format like JPG would produce a more desired file size (for serving imagery). PNG has a 24-bit color palette (256^3 = 16.8 million colors).

In practice, such a large color palette is unnecessary for most map tiles. Unless the layer is rendering imagery files or other content requiring a full color palette, most of the time images will not be using anywhere near that many colors. More importantly, as PNG is not a compressed image format, that 24-bit color palette takes up a lot of unnecessary space.

Consequently, it is recommended to **use PNG8 for tiles whenever possible**. PNG8 is a variant on the standard PNG graphic format, but has only a 256 color palette. This can greatly reduce the size of image files.

For example, here is WMS output for the ``usa:states`` layer with ``format=image/png`` and the same request but using ``format=image/png8``:

  .. figure:: img/optimization_png.png

     *Actual output in PNG format: 31 kB*

  .. figure:: img/optimization_png8.png

     *Actual output in PNG8 format: 14 kB*

:: 

   http://localhost:8080/geoserver/wms/reflect?layers=usa:states&format=image/png
   http://localhost:8080/geoserver/wms/reflect?layers=usa:states&format=image/png8

The sizes are 31,098 bytes and 13,653 bytes, respectively. The PNG8 graphic is 44%, or just over two-fifths the size of the PNG graphic.

The specifics of the disk space savings depend on the disk block size of the storage medium, but in almost all cases, there is a marked decrease in image size, with minor if any visual differences.

Use paletted images
-------------------

.. todo:: Not sure how true this all is.

When generating PNG8 tiles, it is often based on full color palette source imagery, and so the images will need to be "downsampled" to 256 colors. The determination of which 256 colors to use (known as the "palette") is by default determined on a tile-by-tile basis. This can lead to artifacts along tile boundaries, as a single color could be mapped to different colors in different tiles based on the content of each tile.

.. todo:: Need an image to show an example of this.

The way to prevent this is to create a image that consists of the 256 colors to use in the resulting PNG8, and then point GeoServer at this image. This "paletted image" can consist of any image content at all; the importance is the color palette used.

A simple way of generating a paletted image is by taking an appropriate-looking tile generated by GeoServer and using that as the paletted image. A more methodical way to generate the paletted image is to use a photo editing software and create a PNG8 image containing the desired color palette.

When the paletted image is created, it must be added to the initial WMS requests that generate the tiles. This is done with the ``palette=file.png`` parameter. Place this file in the GeoServer data directory to eliminat the need for path info. If that is not possible, place the file in an web-accessible location, and add the path to the parameter: ``palette=http://path/to/file.png``.

.. todo:: But how to hook this up to GWC seeding?

