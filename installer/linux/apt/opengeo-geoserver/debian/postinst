#!/bin/bash
# postinst script for geonode
#
# see: dh_installdeb(1)

. /usr/share/debconf/confmodule

set -e

# summary of how this script can be called:
#	* <postinst> `configure' <most-recently-configured-version>
#	* <old-postinst> `abort-upgrade' <new version>
#	* <conflictor's-postinst> `abort-remove' `in-favour' <package>
#	  <new-version>
#	* <postinst> `abort-remove'
#	* <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#	  <failed-install-package> <version> `removing'
#	  <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

function randpass() {
  [ "$2" == "0" ] && CHAR="[:alnum:]" || CHAR="[:graph:]"
    cat /dev/urandom | tr -cd "$CHAR" | head -c ${1:-32}
    echo
}

function system_primary_ip {
    # returns the primary IP assigned to eth0
    echo $(ifconfig eth0 | awk -F: '/inet addr:/ {print $2}' | awk '{ print $1 }')
}

function configuretomcat() {

	# configure tomcat
	#
	cp /etc/default/tomcat6 /etc/default/tomcat6.orig
	cat <<- EOF >> /etc/default/tomcat6
	JAVA_OPTS="-Djava.awt.headless=true -Xms256m -Xmx768m -Xrs -XX:PerfDataSamplingInterval=500 -XX:MaxPermSize=128m"
	GEOEXPLORER_DATA="/usr/share/opengeo-suite-data/geoexplorer_data"
	EOF

	# Ubuntu versions earlier than 9.10 have this setting turned on, it breaks geoserver.
	sed -i -e 's/TOMCAT6_SECURITY=yes/TOMCAT6_SECURITY=no/g' /etc/default/tomcat6

	# stop the tomcat process to prevent it from automatically unpacking the war files
	#
	invoke-rc.d tomcat6 stop

	# set file permissions and copy the war files in
	#
	cp /usr/share/opengeo-geoserver/geoserver.war /var/lib/tomcat6/webapps
	unzip  -o /var/lib/tomcat6/webapps/geoserver.war  -d /var/lib/tomcat6/webapps/geoserver  > /dev/null 2>&1
    if [ ! -z "$proxyurl" ]; then
      GLOBAL_XML=/usr/share/opengeo-suite-data/geoserver_data/global.xml
      if [ -e $GLOBAL_XML ]; then
        sed -i 's/<\(proxyBaseUrl>.*<\/proxyBaseUrl\)>/<\!--\1-->/g' $GLOBAL_XML
        sed -i "/<\/global>/i \
  <proxyBaseUrl>$proxyurl<\/proxyBaseUrl>" $GLOBAL_XML
      fi
    fi
	chown tomcat6. /usr/share/opengeo-geoserver/*.war
}

function doconfigure() {
db_input high opengeo_geoserver/proxyurl || true
db_go

db_input high opengeo_geoserver/username || true
db_go

db_input high opengeo_geoserver/password || true
db_go
db_get opengeo_geoserver/password

if [ ! -z "$RET" ]; then 
   password="$RET"

   password_ok=0
   while [ $password_ok -ne 1 ]; do
     db_input high opengeo_geoserver/password_confirm || true
     db_go
     db_get opengeo_geoserver/password_confirm
     if [ "$RET" == "$password" ]; then
        password_ok=1
     else
        db_input high opengeo_geoserver/password_mismatch || true
        db_go
        db_get opengeo_geoserver/password_mismatch
        password=$RET
     fi
   done
   
else
   password="geoserver"
fi
}


case "$1" in
    configure)
    
    echo "last configured version = $2"
    doconfigure
	db_get opengeo_geoserver/proxyurl
	if [ "$RET" ]; then
        proxyurl="$RET"
    else
		proxyurl=""
	fi

    db_get opengeo_geoserver/username
    if [ "$RET" ]; then
        username="$RET"
    else
        username="admin"
    fi

    db_get opengeo_geoserver/password_confirm
    password="$RET"
    if [ -z "$password" ]; then
        password="geoserver"
    fi

	configuretomcat
	invoke-rc.d tomcat6 restart
	cat <<- EOF > /usr/share/opengeo-suite-data/geoserver_data/security/users.properties
	$username=$password,ROLE_ADMINISTRATOR
	# These are sample users you may uncomment if you want to test locking down wfs (see service.properties)
	#wfst=wfst,ROLE_WFS_READ,ROLE_WFS_WRITE
	#wfs=wfs,ROLE_WFS_READ
	EOF

	chown tomcat6. /usr/share/opengeo-suite-data/geoserver_data/security/users.properties

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
	echo "postinst called with unknown argument \`$1'" >&2
	exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

db_stop;

exit 0
