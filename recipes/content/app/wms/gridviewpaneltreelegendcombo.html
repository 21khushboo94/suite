<html>
    <head>
        <title>GeoExt WMS Browser</title>

        <script type="text/javascript" src="http://extjs.cachefly.net/ext-3.2.1/adapter/ext/ext-base.js"></script>
        <script type="text/javascript" src="http://extjs.cachefly.net/ext-3.2.1/ext-all.js"></script>
        <link rel="stylesheet" type="text/css" href="http://extjs.cachefly.net/ext-3.2.1/resources/css/ext-all.css" />
        <script src="http://dev.openlayers.org/releases/OpenLayers-2.9.1/OpenLayers.js"></script>

        <script type="text/javascript" src="http://api.geoext.org/0.7/script/GeoExt.js"></script>
        <link rel="stylesheet" type="text/css" href="http://api.geoext.org/0.7/resources/css/geoext-all.css" />

        <script type="text/javascript">
        Ext.BLANK_IMAGE_URL = "http://extjs.cachefly.net/ext-3.2.1/resources/images/default/s.gif";

        Ext.onReady(function() {

            var grid = new Ext.grid.GridPanel({
                title: "Available WMS Layers",
                region: "north",
                height: 150,
                viewConfig: {forceFit: true},
                store: new GeoExt.data.WMSCapabilitiesStore({
                    url: "http://v2.suite.opengeo.org/geoserver/ows?SERVICE=WMS&REQUEST=GetCapabilities",
                    autoLoad: true
                }),
                columns: [
                    {header: "Name", dataIndex: "name", sortable: true},
                    {header: "Title", dataIndex: "title", sortable: true},
                    {header: "Abstract", dataIndex: "abstract"}
                ],
                bbar: [{
                    text: "Add To Map",
                    handler: function() {
                        grid.getSelectionModel().each(function(record) {
                            var clone = record.clone();
                            clone.get("layer").mergeNewParams({
                                format: "image/png",
                                transparent: true
                            });
                            mapPanel.layers.add(clone);
                            mapPanel.map.zoomToExtent(
                                OpenLayers.Bounds.fromArray(clone.get("llbbox"))
                            );
                        });
                    }
                }]
            });

            var mapPanel = new GeoExt.MapPanel({
                title: "Map",
                region: "center",
                bbar: [{
                    xtype: "label",
                    text: "Scale = 1 : "
                }]
            });

            var scaleCombo = new Ext.form.ComboBox({
                width: 130,
                mode: "local",
                emptyText: "Scale",
                triggerAction: "all",
                displayField: "scale",
                store: new GeoExt.data.ScaleStore({
                    map: mapPanel
                }),
                listeners: {
                    select: function(combo, record) {
                        mapPanel.map.zoomTo(record.get("level"));
                    }
                }
            });
            mapPanel.map.events.register("zoomend", this, function() {
                scaleCombo.setValue(mapPanel.map.getScale());
            });
            mapPanel.getBottomToolbar().add(scaleCombo);


            var tree = new Ext.tree.TreePanel({
                region: "west",
                title: "Map Layers",
                width: 200,
                autoScroll: true,
                enableDD: true,
                lines: false,
                rootVisible: false,
                root: new GeoExt.tree.LayerContainer({
                    layerStore: mapPanel.layers,
                    expanded: true
                }),
                bbar: [{
                    text: "Remove from Map",
                    handler: function() {
                        var node = tree.getSelectionModel().getSelectedNode();
                        if(node) {
                            mapPanel.map.removeLayer(node.layer);
                        }
                    }
                }]
            });

            var legend = new GeoExt.LegendPanel({
                region: "east",
                title: "Legend",
                width: 200,
                autoScroll: true,
                layerStore: mapPanel.layers
            });

            new Ext.Panel({
                renderTo: document.body,
                width: 800,
                height: 450,
                layout: "border",
                items: [grid, mapPanel, tree, legend]
            });

            var featureInfo = new OpenLayers.Control.WMSGetFeatureInfo();
            featureInfo.events.on({
                getfeatureinfo: function(e) {
                    new GeoExt.Popup({
                        title: "Feature Info",
                        width: 200,
                        height: 150,
                        autoScroll: true,
                        maximizable: true,
                        map: mapPanel.map,
                        lonlat: mapPanel.map.getLonLatFromPixel(e.xy),
                        html: e.text
                    }).show();
                }
            });
            mapPanel.map.addControl(featureInfo);
            featureInfo.activate();

        });


        </script>
    </head>
    <body>
    </body>
</html>
